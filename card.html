<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cart√£o de Boas-Vindas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/html-to-image@1.11.11/dist/html-to-image.min.js"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&family=Playfair+Display:wght@700&display=swap");

      .title-font {
        font-family: "Playfair Display", serif;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .animate-fade-in {
        animation: fadeIn 0.8s ease-out forwards;
      }

      .floating {
        animation: floating 3s ease-in-out infinite;
      }

      @keyframes floating {
        0% {
          transform: translateY(0px);
        }
        50% {
          transform: translateY(-10px);
        }
        100% {
          transform: translateY(0px);
        }
      }

      /* Estilos de impress√£o robustos */
      @media print {
        html,
        body {
          background: #ffffff !important;
          -webkit-print-color-adjust: exact;
          print-color-adjust: exact;
        }

        .no-print {
          display: none !important;
        }

        #cartao {
          box-shadow: none !important;
          border: 1px solid #000 !important;
          background-image: none !important;
        }

        /* For√ßa todo o texto e √≠cones para preto e fundos para transparente */
        #cartao * {
          color: #000 !important;
          background-color: transparent !important;
          background-image: none !important;
          box-shadow: none !important;
        }
      }
    </style>
  </head>
  <body
    class="bg-gradient-to-tr from-blue-50 to-blue-100 min-h-screen flex items-center justify-center p-4"
  >
    <div
      id="cartao"
      class="bg-white shadow-2xl rounded-2xl p-6 md:p-8 text-center animate-fade-in w-full max-w-md"
    >
      <div class="floating mb-4">
        <img src="./img/ad.jpg" class="w-16 h-16 mx-auto rounded-full" />
      </div>

      <h1 class="title-font text-2xl md:text-3xl font-bold text-[#004181] mb-4">
        üéâ Bem-vindo √† Fam√≠lia de Cristo!
      </h1>

      <div class="bg-blue-50 rounded-xl p-4 mb-4 border border-blue-200">
        <p id="mensagem" class="text-gray-900 font-medium text-lg"></p>
        <p id="data" class="text-sm text-gray-900 mt-2 font-semibold"></p>
        <p id="motivo" class="italic text-gray-900 mt-2 text-sm"></p>
      </div>

      <blockquote
        class="border-l-4 border-[#004181] pl-4 text-gray-900 mb-4 text-sm md:text-base text-left bg-blue-50 p-3 rounded-r-lg"
      >
        "Porque este meu filho estava morto, e reviveu, tinha-se perdido, e foi
        achado. E come√ßaram a alegrar-se."
        <span class="block text-sm mt-1 font-semibold text-[#004181]"
          >Lucas 15:24</span
        >
      </blockquote>

      <div
        class="text-left text-gray-900 text-sm mb-4 bg-blue-50 p-4 rounded-xl border border-blue-200"
      >
        <p class="font-semibold text-[#004181] mb-2">Dias de culto:</p>
        <ul class="ml-4 list-disc space-y-1">
          <li>Segunda-feira (ora√ß√£o): 19h30</li>
          <li>Quarta-feira: 19h30</li>
          <li>Sexta-feira: 19h30</li>
          <li>Domingo: 18h30</li>
        </ul>
        <p class="mt-3 font-semibold text-[#004181]">Endere√ßo:</p>
        <p>Rua √Ågua Branca, 81 ‚Äî Vila Ruy Barbosa, Jundia√≠</p>
      </div>

      <p
        class="text-[#004181] font-semibold mb-4 text-sm md:text-base border-t border-blue-200 pt-4"
      >
        Igreja Evang√©lica Assembleia de Deus ‚Äî Ruy Barbosa
      </p>

      <!-- Bot√µes que ser√£o ocultos na impress√£o -->
      <div class="no-print space-y-3">
        <button
          id="download"
          class="bg-[#004181] text-white px-4 py-3 rounded-xl hover:bg-[#002c5a] transition-all w-full flex items-center justify-center"
        >
          <i class="fas fa-camera mr-2"></i> Salvar como imagem
        </button>

        <button
          id="share"
          style="display: none"
          class="bg-green-500 text-white px-4 py-3 rounded-xl hover:bg-green-600 transition-all w-full flex items-center justify-center"
        >
          <i class="fas fa-share-alt mr-2"></i> Compartilhar
        </button>

        <a
          href="index.html"
          class="block text-[#004181] hover:text-[#002c5a] transition-colors text-sm"
        >
          <i class="fas fa-arrow-left mr-1"></i> Criar outro cart√£o
        </a>
      </div>
    </div>

    <script>
      // --- L√ìGICA INICIAL ---

      // Obter par√¢metros da URL
      const urlParams = new URLSearchParams(window.location.search);
      const nome = decodeURIComponent(urlParams.get("nome") || "Pessoa");
      const dataParam = decodeURIComponent(urlParams.get("data") || "");
      const motivo = decodeURIComponent(urlParams.get("motivo") || "");
      const tipo = decodeURIComponent(urlParams.get("tipo") || "");

      // Formatar data (com corre√ß√£o de fuso hor√°rio)
      let dataFormatada = "";
      if (dataParam) {
        const data = new Date(dataParam);
        const userTimezoneOffset = data.getTimezoneOffset() * 60000;
        const correctedDate = new Date(data.getTime() + userTimezoneOffset);
        dataFormatada = correctedDate.toLocaleDateString("pt-BR", {
          day: "2-digit",
          month: "2-digit",
          year: "numeric",
        });
      }

      // Definir mensagem baseada no tipo de decis√£o
      let mensagem = "";
      if (tipo === "primeira") {
        mensagem = `${nome}, celebramos sua decis√£o de aceitar Jesus Cristo como seu Salvador!`;
      } else if (tipo === "retornando") {
        mensagem = `${nome}, celebramos seu retorno aos bra√ßos do Pai!`;
      } else {
        mensagem = `${nome}, celebramos sua decis√£o por Cristo!`;
      }

      // Atualizar elementos da p√°gina
      document.getElementById("mensagem").textContent = mensagem;
      document.getElementById("data").textContent = dataFormatada
        ? `Data da decis√£o: ${dataFormatada}`
        : "";
      document.getElementById("motivo").textContent = motivo || "";

      // --- L√ìGICA DE BOT√ïES (DOWNLOAD E COMPARTILHAMENTO) ---

      const cardElement = document.getElementById("cartao");
      const downloadBtn = document.getElementById("download");
      const shareBtn = document.getElementById("share");

      /**
       * Prepara a UI, gera a imagem do cart√£o e restaura a UI.
       * @param {number} pixelRatio - A resolu√ß√£o da imagem (ex: 2 para 2x).
       * @returns {Promise<string>} A imagem em formato data URL.
       */
      async function generateCardImage(pixelRatio = 2) {
        const botoes = document.querySelector(".no-print");
        
        // 1. Preparar UI para captura
        if (botoes) botoes.style.display = "none";
        cardElement.classList.remove("floating");

        try {
          // Delay para garantir que a UI foi renderizada antes da captura
          await new Promise((resolve) => setTimeout(resolve, 100));

          const dataUrl = await htmlToImage.toPng(cardElement, {
            quality: 1,
            backgroundColor: "#ffffff",
            pixelRatio: pixelRatio,
          });
          return dataUrl;
        } finally {
          // 2. Restaurar UI ap√≥s captura
          if (botoes) botoes.style.display = "block";
          cardElement.classList.add("floating");
        }
      }

      // Configurar bot√£o de Download
      downloadBtn.addEventListener("click", async () => {
        try {
          const dataUrl = await generateCardImage(2); // Qualidade alta (2x) para download
          const link = document.createElement("a");
          link.download = `cartao-boas-vindas-${nome}.png`;
          link.href = dataUrl;
          link.click();
        } catch (error) {
          console.error("Erro ao gerar imagem para download:", error);
          alert("Erro ao gerar imagem. Tente novamente.");
        }
      });

      // Configurar bot√£o de Compartilhamento
      if (navigator.share && navigator.canShare) {
        shareBtn.style.display = "flex"; // Mostra o bot√£o se a API for suportada

        shareBtn.addEventListener("click", async () => {
          try {
            // Gera imagem com qualidade boa para compartilhamento (mais leve)
            const dataUrl = await generateCardImage(2);
            
            // Converte a imagem de dataURL para um objeto File
            const blob = await (await fetch(dataUrl)).blob();
            const file = new File([blob], `cartao-boas-vindas-${nome}.png`, {
              type: blob.type,
            });

            // Verifica se o navegador pode compartilhar arquivos
            if (navigator.canShare({ files: [file] })) {
              await navigator.share({
                files: [file],
                title: "Cart√£o de Boas-Vindas",
                text: "Celebre esta nova jornada!",
              });
            } else {
              alert("Seu navegador n√£o suporta o compartilhamento de arquivos.");
            }
          } catch (error) {
            // Ignora o erro se o usu√°rio cancelar a a√ß√£o de compartilhar
            if (error.name !== "AbortError") {
              console.error("Erro ao compartilhar:", error);
              alert("Ocorreu um erro ao tentar compartilhar.");
            }
          }
        });
      }
    </script>
  </body>
</html>
